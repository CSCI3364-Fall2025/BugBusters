{% extends 'base.html' %}
{% load static %}

{% block title %}
{% if is_edit %}Edit Peer Assessment Form{% else %}Create Peer Assessment Form{% endif %} - EagleOps
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="header-left">
            <a href="{% url 'course_detail' course.id %}" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to {{ course.name }}
            </a>
            <h1>{% if is_edit %}Edit Peer Assessment Form{% else %}Create Peer Assessment Form{% endif %}</h1>
        </div>
        <div class="header-actions">
            <button id="discard-btn" class="btn btn-secondary">Discard Draft</button>
            <button id="save-btn" class="btn btn-primary">Save Changes</button>
        </div>
    </div>

    <div class="section">
        <h2>Assessment Configuration</h2>
        <div id="save-message" class="success-message" style="display: none;">
            Form saved successfully!
        </div>
        <div id="error-message" class="error-message" style="display: none;">
            Error saving form.
        </div>
        <div class="form-group">
            <label for="form-title">Form Title <span class="required">*</span></label>
            <input type="text" id="form-title" class="form-control" value="{{ form.title|default:'' }}" required>
        </div>

        {% if not is_edit %}
        <div class="form-group">
            <label for="template-select">Based on Template <span class="required">*</span></label>
            <select id="template-select" class="form-control" required>
                <option value="">Select a template</option>
                {% for template in templates %}
                <option value="{{ template.id }}">{{ template.title }}</option>
                {% endfor %}
            </select>
        </div>
        {% else %}
        <div class="form-group">
            <label>Based on Template</label>
            <div class="static-field">{{ form.template.title }}</div>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="publication-date">Publication Date <span class="required">*</span></label>
            <input type="datetime-local" id="publication-date" class="form-control" value="{{ form.publication_date|date:'Y-m-d\TH:i'|default:'' }}" required>
        </div>

        <div class="form-group">
            <label for="closing-date">Closing Date <span class="required">*</span></label>
            <input type="datetime-local" id="closing-date" class="form-control" value="{{ form.closing_date|date:'Y-m-d\TH:i'|default:'' }}" required>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Assign Teams</h2>
            <div class="help-text">Select teams that will receive this assessment</div>
        </div>
        
        {% if teams %}
        <div class="team-selection">
            {% for team in teams %}
            <div class="team-button {% if team.id in selected_teams %}selected{% endif %}" data-id="{{ team.id }}">
                <div class="team-name">{{ team.name }}</div>
                <div class="team-count">{{ team.members.count }} Member{{ team.members.count|pluralize }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-content">
            <p>No teams available for this course.</p>
        </div>
        {% endif %}
        
        <div class="self-assessment-toggle">
            <div class="toggle-label">Enable Self Assessment</div>
            <div class="toggle-buttons">
                <button class="toggle-btn {% if form.self_assessment %}selected{% endif %}" data-value="true">ON</button>
                <button class="toggle-btn {% if not form.self_assessment %}selected{% endif %}" data-value="false">OFF</button>
            </div>
        </div>
    </div>

    <div class="footer-actions">
        <button id="preview-btn" class="btn btn-secondary">
            <i class="fas fa-eye"></i> Preview Form
        </button>
        <div>
            <a href="{% url 'course_detail' course.id %}" class="btn btn-secondary">Back to Forms</a>
            {% if form and form.status == 'draft' %}
            <form method="post" action="{% url 'form_open' course.id form.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">Open Form</button>
            </form>
            {% elif form %}
            <form method="post" action="{% url 'form_close' course.id form.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Close Form</button>
            </form>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #c3e6cb;
    }
    
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
    }
    
    .back-link {
        display: block;
        margin-bottom: 10px;
        color: #4a86e8;
        text-decoration: none;
    }
    
    .back-link:hover {
        text-decoration: underline;
    }
    
    .header-actions {
        display: flex;
        gap: 10px;
    }
    
    .section {
        background-color: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .section-header {
        margin-bottom: 20px;
    }
    
    .help-text {
        color: #6c757d;
        font-size: 14px;
        margin-top: 5px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .required {
        color: #dc3545;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    
    .static-field {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #eee;
    }
    
    .team-selection {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .team-button {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .team-button:hover {
        background-color: #e9ecef;
    }
    
    .team-button.selected {
        background-color: #4a86e8;
        color: white;
    }
    
    .team-name {
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .team-count {
        font-size: 13px;
        color: inherit;
        opacity: 0.8;
    }
    
    .self-assessment-toggle {
        margin-top: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    
    .toggle-label {
        font-weight: 500;
        margin-bottom: 10px;
    }
    
    .toggle-buttons {
        display: flex;
        gap: 10px;
    }
    
    .toggle-btn {
        background-color: #f8f9fa;
        border: 2px solid #ddd;
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .toggle-btn:hover {
        background-color: #e9ecef;
    }
    
    .toggle-btn.selected {
        background-color: #4a86e8;
        border-color: #4a86e8;
        color: white;
    }
    
    .btn, .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        border: none;
    }
    
    .btn-primary {
        background-color: #4a86e8;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #3a76d8;
    }
    
    .btn-secondary {
        background-color: #f8f9fa;
        border: 1px solid #6c757d;
        color: #333;
    }
    
    .btn-secondary:hover {
        background-color: #e9ecef;
    }
    
    .btn-success {
        background-color: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #218838;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #c82333;
    }
    
    .footer-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }
    
    .footer-actions > div {
        display: flex;
        gap: 10px;
    }
    
    .no-content {
        text-align: center;
        padding: 30px;
        color: #6c757d;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const courseId = {{ course.id }};
        const formId = {% if form %}{{ form.id }}{% else %}null{% endif %};
        const isEdit = {% if is_edit %}true{% else %}false{% endif %};
        
        // DOM Elements
        const formTitle = document.getElementById('form-title');
        const templateSelect = document.getElementById('template-select');
        const publicationDate = document.getElementById('publication-date');
        const closingDate = document.getElementById('closing-date');
        const teamButtons = document.querySelectorAll('.team-button');
        const toggleButtons = document.querySelectorAll('.toggle-btn');
        const saveBtn = document.getElementById('save-btn');
        const discardBtn = document.getElementById('discard-btn');
        const previewBtn = document.getElementById('preview-btn');
        
        // Add event listeners to clear messages when user makes changes
        formTitle.addEventListener('input', clearMessages);
        if (templateSelect) templateSelect.addEventListener('change', clearMessages);
        publicationDate.addEventListener('input', clearMessages);
        closingDate.addEventListener('input', clearMessages);
        
        teamButtons.forEach(button => {
            button.addEventListener('click', function() {
                clearMessages();
                this.classList.toggle('selected');
            });
        });
        
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                clearMessages();
                toggleButtons.forEach(btn => btn.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
        
        // Save button
        saveBtn.addEventListener('click', function() {
            saveForm();
        });
        
        // Discard button
        discardBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to discard your changes? This cannot be undone.')) {
                window.location.href = `/courses/${courseId}/`;
            }
        });
        
        // Preview button
        previewBtn.addEventListener('click', async function() {
            // Save current state first
            const response = await saveForm();
            if (response && response.status === 'success') {
                // Navigate to preview page using the saved form ID
                const savedFormId = response.form_id || formId;
                window.location.href = `/courses/${courseId}/forms/${savedFormId}/preview/`;
            }
        });
        
        // FUNCTIONS
        
        // Clear status messages
        function clearMessages() {
            document.getElementById('save-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
        }
        
        // Save form function
        async function saveForm() {
            // Validate
            if (!formTitle.value.trim()) {
                alert('Form title is required');
                return null;
            }
            
            if (!isEdit && !templateSelect.value) {
                alert('Template selection is required');
                return null;
            }
            
            if (!publicationDate.value) {
                alert('Publication date is required');
                return null;
            }
            
            if (!closingDate.value) {
                alert('Closing date is required');
                return null;
            }
            
            // Get selected teams
            const selectedTeams = [];
            document.querySelectorAll('.team-button.selected').forEach(team => {
                selectedTeams.push(team.getAttribute('data-id'));
            });
            
            if (selectedTeams.length === 0) {
                alert('At least one team must be selected');
                return null;
            }
            
            // Get self-assessment value
            let selfAssessment = false;
            document.querySelectorAll('.toggle-btn.selected').forEach(btn => {
                if (btn.getAttribute('data-value') === 'true') {
                    selfAssessment = true;
                }
            });
            
            // Prepare data for saving
            const data = {
                title: formTitle.value.trim(),
                template_id: isEdit ? {% if form and form.template %}{{ form.template.id }}{% else %}null{% endif %} : parseInt(templateSelect.value),
                publication_date: publicationDate.value,
                closing_date: closingDate.value,
                team_ids: selectedTeams,
                self_assessment: selfAssessment
            };
            
            console.log('Form data:', data);
            
            // Save to server
            try {
                const url = isEdit 
                    ? `/courses/${courseId}/forms/${formId}/edit/` 
                    : `/courses/${courseId}/forms/create/`;
                
                console.log('Sending request to:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Server response:', result);
                    
                    if (result.status === 'success') {
                        // Show success message
                        const saveMessage = document.getElementById('save-message');
                        saveMessage.style.display = 'block';
                        saveMessage.textContent = isEdit ? 'Form updated successfully!' : 'Form created successfully!';
                        
                        // Scroll to top to show the message
                        window.scrollTo(0, 0);
                        
                        // For new forms, redirect to edit page after a short delay
                        if (!isEdit && result.form_id) {
                            setTimeout(() => {
                                window.location.href = `/courses/${courseId}/forms/${result.form_id}/edit/`;
                            }, 1500);
                            return null;
                        }
                        return result;
                    } else {
                        const errorMsg = document.getElementById('error-message');
                        errorMsg.textContent = 'Error: ' + (result.message || 'Unknown error');
                        errorMsg.style.display = 'block';
                        window.scrollTo(0, 0);
                        return null;
                    }
                } else {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // If response isn't JSON, try to get text
                        const errorText = await response.text();
                        if (errorText) {
                            errorMessage = errorText;
                        }
                    }
                    
                    console.error('Server error:', errorMessage);
                    const errorMsg = document.getElementById('error-message');
                    errorMsg.textContent = 'An error occurred while saving the form: ' + errorMessage;
                    errorMsg.style.display = 'block';
                    window.scrollTo(0, 0);
                    return null;
                }
            } catch (error) {
                console.error('Exception:', error);
                const errorMsg = document.getElementById('error-message');
                errorMsg.textContent = 'An error occurred while saving the form: ' + error.message;
                errorMsg.style.display = 'block';
                window.scrollTo(0, 0);
                return null;
            }
        }
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %} 