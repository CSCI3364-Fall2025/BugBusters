# Generated by Django 5.1.5 on 2025-03-18 15:23

from django.db import migrations
from django.conf import settings


def create_site(apps, schema_editor):
    # We get the model from the versioned app registry;
    # if we directly import it, it'll be the wrong version
    Site = apps.get_model("sites", "Site")
    
    # Create or update the site with ID from settings
    Site.objects.update_or_create(
        id=settings.SITE_ID,
        defaults={
            "domain": "example.com",
            "name": "EagleOps"
        }
    )


def create_social_app(apps, schema_editor):
    SocialApp = apps.get_model("socialaccount", "SocialApp")
    Site = apps.get_model("sites", "Site")
    
    # Check if we already have a Google provider
    if not SocialApp.objects.filter(provider="google").exists():
        # Create the social app
        google_app = SocialApp.objects.create(
            provider="google",
            name="Google OAuth",
            client_id=settings.SOCIAL_AUTH_GOOGLE_OAUTH2_KEY,
            secret=settings.SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET,
            key=""
        )
        
        # Add the site to the social app
        google_app.sites.add(Site.objects.get(id=settings.SITE_ID))


def reverse_func(apps, schema_editor):
    # No need to delete anything when reversing the migration
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('pages', '0002_userprofile_delete_googleoauthprofile'),
        ('sites', '0001_initial'),
        ('socialaccount', '0001_initial'),
    ]

    operations = [
        migrations.RunPython(create_site, reverse_func),
        migrations.RunPython(create_social_app, reverse_func),
    ]
